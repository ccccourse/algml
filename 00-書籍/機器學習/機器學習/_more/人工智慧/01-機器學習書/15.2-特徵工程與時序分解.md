### **特徵工程與時序分解**

在時間序列分析中，**特徵工程** 和 **時序分解** 是兩個非常重要的步驟。它們有助於從原始數據中提取有用的信息，並為預測模型提供更精確的輸入。這些技術在處理具有季節性、趨勢性或其他模式的時間序列數據時尤為重要。

---

### **1. 特徵工程**

特徵工程（Feature Engineering）是將原始數據轉化為對模型有意義的特徵（features）的過程。在時間序列中，特徵工程主要集中於從時間戳（timestamp）和其他外部特徵中提取有價值的信息。常見的時間序列特徵包括：

#### **a. 日期與時間特徵**
- **週期性特徵**：例如，季節性、每月、每季、每年等。在處理時間序列時，常常需要將時間信息轉換為週期性特徵（例如，將每月的數據轉換為月份特徵）。
  - **月份**、**季度**、**星期幾**等（這些特徵對於模型預測季節性模式非常重要）。
  
  例如，將日期轉換為月份：
  ```python
  import pandas as pd
  df['month'] = df['date'].dt.month
  df['day_of_week'] = df['date'].dt.dayofweek
  ```

#### **b. 時間滯後特徵**
- 在時間序列中，當前的觀測值通常依賴於過去的觀測值，因此可以創建**滯後特徵**，即將過去的觀測值用作當前預測的輸入特徵。
  - 如 `X(t-1)`, `X(t-2)`, `X(t-3)`，等。
  ```python
  df['lag_1'] = df['value'].shift(1)
  df['lag_2'] = df['value'].shift(2)
  ```

#### **c. 滾動統計特徵**
- 滾動窗口統計（如滾動平均、滾動標準差）能夠捕捉時間序列中的局部趨勢和波動。
  - 例如，可以計算過去 3 天的平均數、標準差等。
  ```python
  df['rolling_mean_3'] = df['value'].rolling(window=3).mean()
  df['rolling_std_3'] = df['value'].rolling(window=3).std()
  ```

#### **d. 外部特徵（Exogenous Features）**
- 除了時間和滯後特徵之外，還可以將外部變量作為額外的特徵。這些變量不一定來自於時間序列本身，但可能會對預測產生影響。例如，天氣數據、假期、廣告支出等外部數據。

---

### **2. 時序分解**

時序分解是將時間序列數據分解為趨勢（Trend）、季節性（Seasonality）和隨機噪音（Noise）成分的過程。通過這種分解，可以更清楚地理解數據的內在結構，並更有效地建模。

#### **a. 時序分解的基本概念**
- **趨勢（Trend）**：數據的長期變化模式，通常是上升或下降的趨勢。
- **季節性（Seasonality）**：數據中的周期性變化，例如每年、每月或每周重複的模式。
- **隨機噪音（Noise）**：無法由趨勢或季節性解釋的隨機變化。

#### **b. 加法模型 vs. 乘法模型**
- **加法模型**：適用於趨勢和季節性變化幅度較為固定的情況，分解為：
  \[
  Y_t = T_t + S_t + E_t
  \]
  其中 \(Y_t\) 是觀測值，\(T_t\) 是趨勢，\(S_t\) 是季節性，\(E_t\) 是隨機噪音。

- **乘法模型**：適用於隨著時間增長，趨勢或季節性變化幅度增大的情況，分解為：
  \[
  Y_t = T_t \cdot S_t \cdot E_t
  \]
  這表示趨勢、季節性和隨機噪音相乘。

#### **c. 時序分解的實現**
在 Python 中，`statsmodels` 库提供了方便的時間序列分解工具，可以使用 `seasonal_decompose` 函數來進行時序分解。這個函數支持加法模型和乘法模型。

```python
import pandas as pd
import statsmodels.api as sm
import matplotlib.pyplot as plt

# 創建一些模擬數據
dates = pd.date_range('2021-01-01', periods=365, freq='D')
data = pd.Series(10 + 0.1 * dates.dayofyear + 2 * np.sin(2 * np.pi * dates.dayofyear / 365) + np.random.normal(scale=1, size=365), index=dates)

# 時序分解
result = sm.tsa.seasonal_decompose(data, model='additive', period=365)

# 可視化分解結果
result.plot()
plt.show()
```

在這段代碼中，我們創建了一個包含趨勢、季節性和隨機噪音的模擬數據，並使用 `seasonal_decompose` 進行加法模型的時序分解。分解結果會顯示出趨勢成分、季節性成分和殘差。

#### **d. 使用分解結果進行預測**
通過時序分解，我們可以分別對趨勢和季節性進行建模，然後將它們的預測結果合併，以進行更精確的預測。

---

### **3. 特徵工程與時序分解的結合**

特徵工程與時序分解的結合能夠幫助我們更好地理解數據的結構，並改善預測模型的效果。這裡有幾個可能的結合方法：
- **將分解出的趨勢和季節性作為額外特徵**：在建立預測模型時，可以將時序分解的趨勢成分和季節性成分作為特徵，並與其他特徵（如滯後項和外部特徵）結合，從而提高預測準確性。
- **去除噪音後建模**：將數據中的噪音部分移除，只保留趨勢和季節性成分，進行建模。這樣可以減少隨機變動對預測的影響。

---

### **4. 小結**

- **特徵工程**：通過提取時間序列中的週期性特徵、滯後特徵、滾動統計特徵和外部特徵，可以為時間序列建模提供更多有用的信息。
- **時序分解**：將時間序列數據分解為趨勢、季節性和隨機噪音，有助於理解數據的結構並改善模型的預測性能。
- **結合特徵工程與時序分解**：將分解結果作為額外的特徵引入模型中，可以進一步提高時間序列預測的準確性。

這些技術是處理時間序列數據時的重要工具，能夠幫助我們從複雜的時間序列中提取有價值的信息，並進行有效的預測。