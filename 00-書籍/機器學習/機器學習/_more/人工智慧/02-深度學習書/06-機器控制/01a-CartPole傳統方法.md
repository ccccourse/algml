## ccc: 控制理論如何解決 CartPole 問題

**CartPole 問題**（小車-倒單擺）是一個經典的控制理論案例，其目標是在小車上穩定地控制倒立的擺，使其不會倒下並保持小車的水平位置。這個問題通常用來演示如何應用控制理論來解決實際問題。

以下是控制理論解決 CartPole 問題的詳細步驟：

---

## **1. 建立系統的數學模型**

### **(1) 系統描述**
- 小車質量 \(m_c\)、擺桿質量 \(m_p\)。
- 擺桿長度 \(l\)、重力加速度 \(g\)。
- 小車位置 \(x\)，擺的角度（從垂直方向逆時針計）為 \(\theta\)。

### **(2) 動態方程**
使用牛頓第二定律或拉格朗日方法，可以得到以下動態方程：
\[
\ddot{x} = \frac{F + m_p l \dot{\theta}^2 \sin\theta - m_p g \sin\theta \cos\theta}{m_c + m_p - m_p \cos^2\theta}
\]
\[
\ddot{\theta} = \frac{g \sin\theta - \cos\theta \frac{F + m_p l \dot{\theta}^2 \sin\theta}{m_c + m_p}}{l \left( \frac{4}{3} - \frac{m_p \cos^2\theta}{m_c + m_p} \right)}
\]

這些非線性方程描述了系統的動態行為。

### **(3) 線性化**
為簡化控制器設計，通常在平衡點附近（\(\theta \approx 0, \dot{\theta} \approx 0\)）對系統進行線性化，得到：
\[
\ddot{x} = \frac{F}{m_c + m_p}
\]
\[
\ddot{\theta} = \frac{g \theta}{l} - \frac{F}{l (m_c + m_p)}
\]

線性化後，系統可以用狀態空間模型表示：
\[
\dot{\mathbf{x}} = A\mathbf{x} + B\mathbf{u}
\]
\[
\mathbf{y} = C\mathbf{x} + D\mathbf{u}
\]
其中：
\[
\mathbf{x} = \begin{bmatrix} x \\ \dot{x} \\ \theta \\ \dot{\theta} \end{bmatrix}, \quad \mathbf{u} = F
\]

---

## **2. 設計控制器**

### **(1) PID 控制器**
PID 控制器可以針對某一個狀態變量（例如擺角 \(\theta\)）進行控制。
- **P（比例）**：減小擺的角度偏差。
- **I（積分）**：消除穩態誤差。
- **D（微分）**：減少擺的震盪。
- **挑戰**：對於高維多變量系統（\(\mathbf{x} = [x, \dot{x}, \theta, \dot{\theta}]\)），單純使用 PID 不容易穩定控制。

### **(2) 狀態反饋控制（LQR）**
線性二次調節器（LQR）是一種常用的最優控制方法。
1. **目標**：通過選擇控制輸入 \(F\)，最小化以下性能指標：
   \[
   J = \int_0^\infty (\mathbf{x}^T Q \mathbf{x} + u^T R u) dt
   \]
   其中 \(Q\) 和 \(R\) 是權重矩陣，用來平衡狀態偏差和控制輸入的消耗。
2. **優化解**：
   - 通過求解黎卡提方程，計算最優增益矩陣 \(K\)。
   - 控制律為：\(\mathbf{u} = -K\mathbf{x}\)。
3. **結果**：
   - LQR 控制可以同時穩定倒擺角度和小車位置。

### **(3) 模型預測控制（MPC）**
1. **原理**：基於系統模型，預測未來一段時間內的系統行為。
2. **步驟**：
   - 在每次控制迭代中解決一個帶約束的優化問題。
   - 設計控制輸入 \(F\)，使得小車保持穩定，並滿足輸入和狀態的約束（例如輸入力的上限）。
3. **優點**：對於約束和多變量系統特別有效。

---

## **3. 模擬與驗證**
- 使用 MATLAB、Python（例如 `control` 或 `scipy` 庫）模擬線性化模型或原始非線性模型。
- 逐步調整控制器參數（例如 PID 增益或 LQR 權重矩陣），直到滿足穩定性和性能需求。

---

## **挑戰與注意事項**
1. **模型不精確**：實際系統可能與理論模型有偏差，尤其是非線性系統。
   - 解決方法：使用強健控制或自適應控制。
2. **干擾和噪聲**：如摩擦力、風等外部干擾。
   - 解決方法：設計觀測器（如卡爾曼濾波器）估計未測量狀態。
3. **非線性效應**：當擺的角度偏離平衡點較大時，線性化模型可能無法準確描述行為。
   - 解決方法：使用非線性控制方法（如滑模控制）。

---

### **總結**
使用控制理論解決 CartPole 問題時，從建立數學模型到設計控制器是系統化的過程。常用的 PID 和 LQR 是簡單且有效的選擇，而 MPC 在更複雜的情況下表現更佳。通過模擬和實驗，可以進一步驗證和改進控制策略的性能。

