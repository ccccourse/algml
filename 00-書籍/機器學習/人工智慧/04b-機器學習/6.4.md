## 6.4 狀態空間

## 什麼是狀態空間？

狀態空間是動態系統概念的一個重要部分，用於描述模型系統的狀態和狀態間的轉移，通常用於設計和分析時間序列模型。狀態空間模型支持標準的狀態空間表示，其中狀態表示系統隨時間變化所處的狀態，觀察者可以存取這些狀態，但是系統動態方程式沒有明確地觀察到。如果你以前研究過 Kalman 濾波器，那麼你已經與這個概念相當接近了。

## 狀態空間的結構

狀態空間模型的主要結構分為三個部分，分別是狀態空間模型的建立、觀察方程模型的建立（觀測模型以狀態建立狀態對應觀察量之間的關係）和隱藏狀態預測。下面我們以 scikit-learn 中的例子來講解狀態空間建模的基本步驟。

假設我們有一個時間序列：

```
Time                1       2       3       4       5
Price of Apple Inc  500.00  505.96  504.05  524.50  520.5
```

我們想要使用狀態空間模型預測未來的價格。首先，我們需要將觀測序列轉換為狀態空間模型。

### 狀態空間模型的建立

將觀測值轉化為狀態，可以使用以下方法：

$$ \hat{x_t} = f(x_{t-1}, u_{t-1}) + w_{t-1} $$

其中，$\hat{x_t}$ 為估計的狀態，在本例中是 Apple Inc stock 在時間 $t$ 的價格，$f$ 是狀態轉換函數，$u$ 是狀態轉換的外在影響因素，$w$ 是隨機干擾項。

#### 狀態轉換函數

在本例中，我們可以使用一個簡單的狀態轉換函數來建立這個模型：

$$ x_t = x_{t-1} + \beta + \epsilon_t $$

其中，$x_t$ 是 Apple Inc. 股票在時間 $t$ 的價格，$\beta$ 是股票價格的外生趨勢，$\epsilon_t$ 是隨機干擾項。狀態轉換函數 $f$ 定義為：

```python
def transition(state, trend):
    return state + trend + np.random.normal(0, 1)
```

這個函數接受一個狀態變數 `state` 和外生趨勢 `trend`，然後返回下一個狀態值。當我們加上隨機干擾項時，我們會獲得一個新的均值為 $x_{t-1} + \beta$ 的高斯分佈。

#### 隨機干擾項

每個狀態轉換都有一個隨機干擾項，可以用以下方法產生：

```python
def noise():
    return np.random.normal(0, 1)
```

#### 初始化

設置一些變量來存儲狀態和觀測。在本例中，我們可以將 $x_0$ 初始化為序列中的第一項值，而 $P_0$ 則可以初始化為一個大的數字（例如 1e6）。

```python
# State vector initialization
x = [500]
P = [1e6]
```

### 觀察方程模型的建立

接下來，我們需要建立觀察方程模型，也稱為觀察模型。觀察方程模型描述了狀態和觀察之間的關係，從而將觀察值轉換為狀態。

在本例中，我們可以使用以下觀察方程：

$$ y_t = x_t + v_t $$

其中，$y_t$ 是觀察值，$\hat{x_t}$ 是狀態預測，$v_t$ 是隨機干擾項。觀察方程的 Python 實現如下：

```python
def observation(state):
    return state + np.random.normal(0, 5)
```

觀察函數接受一個狀態變數，並使用一個隨機干擾項產生一個觀察值。

### 隱藏狀態預測

我們現在可以預測隱藏狀態了。隱藏狀態是當前股票價格的藍圖，可以通過當前價格和外生趨勢進行預測。在本例中，我們將從第 2 天開始，一直預測到第 5 天：

```python
# Predict the states from the 2nd day until the end
for i in range(1, 5):
    # Generate an estimate of the prior state
    x_prior = transition(x[-1], trend)
    P_prior = P[-1] + 0.1

    # Compute the likelihood
    obs = observation(x_prior)
    likelihood = norm.pdf(price[i], loc=obs, scale=5)

    # PP step
    P_tt = 1 / (1 / P_prior + (1 / 5) ** 2)
    x_tt = x_prior + P_tt * (price[i] - obs) / 5 ** 2

    # AP step
    x.append(x_tt)
    P.append(P_tt)
```

其中，`trend` 是平均外生趨勢，可以初始化為 0。在這種情況下，我們使用前一天的價格作為狀態的先驗，通過狀態轉換函數生成下一天的狀態的先驗。然後，我們計算一個可能性，該可能性實際上是當前價格與生成的先驗之間的高斯分布。我們使用可信區間來進一步縮小可能性范圍，然後計算預測標量（$x_{t+1}$）的均值和方差，以在下一步中使用。在 AP 步驟中，我們將 $x_{t+1}$ 添加到列表中，並更新對應的擊穿值。然後我們回到 PP 步，並再次使用先前的價格來預測下一天的價格，並重複 AP 和 PP 步驟。反復執行此操作，直到預測到我們感興趣的最後一天為止，即第 5 天。

## 結論

這是狀態空間模型的一個簡單的示例，展示了如何使用 scikit-learn 执行一些基本的隱藏狀態預測。在實際應用中，狀態空間模型可用於解決各種問題，包括預測和分析時間序列，計算股票波動率等等。